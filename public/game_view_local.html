<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOCAL - Game Screen View</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link rel="stylesheet" href="css/style.css?v=<?php echo filemtime('css/style.css'); ?>">
    <style>
        /* Override to make the game screen visible by default for local dev */
        #gameScreen {
            /* This is the key change: Apply the grid layout directly here */
            display: grid;
            grid-template-columns: 320px 1fr; /* Fixed width for keypad, flexible for leaderboard */
            grid-template-rows: auto 1fr auto; /* Header, main content, chart */
            gap: 20px;
            grid-template-areas:
                "header header"
                "keypad leaderboard"
                "chart chart";
            max-width: 900px;
            margin: 0 auto;
        }
        /* Local-only styles for the new keypad layout */
        .dartboard-keypad .specials {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .specials-row {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(3, 1fr); /* Default to 3 columns for the first row */
        }
        .specials-row:last-child {
            grid-template-columns: repeat(2, 1fr); /* 2 columns for the second row */
        }
        /* New rule to make the special buttons fit */
        .specials-row .key {
            font-size: 1.1em; /* Reduce font size to help text fit */
            padding: 18px 5px; /* Reduce horizontal padding */
        }
        /* New styles for the separated player cards */
        .player-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .player-card {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
        }
        .player-card--header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid transparent;
            transition: border-color 0.3s;
        }
        .player-card--header.active {
            border-color: var(--active-player-bg);
        }
        .player-card--history {
            padding: 5px 15px; /* Less vertical padding for the history card */
            flex-grow: 1; /* Allow the history card to grow to fill available space */
            /* This is the key fix: Make this a flex container to control its child table */
            display: flex;
        }
        /* Fix for the controls container layout */
        .controls.keypad-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        /*
         * THE DEFINITIVE FIX for the leaderboard spacing and modal visibility.
         */
        .player-card__score-history {
            flex-grow: 0 !important; /* Prevent the table itself from stretching */
        }
        .modal {
            display: none; /* Ensure the win modal is hidden by default */
        }
    </style>
</head>
<body>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen game-container active" data-rendered="false">
        <header>
            <button id="resetGameBtn" class="reset-link-button">‚Üê New Game</button>
            <button id="forceResetBtn" class="reset-link-button" style="color: #dc3545; margin-left: auto;">Force Reset</button>
            <span id="legDisplay" class="header-title"></span>
        </header>

        <div class="leaderboard" id="leaderboard"></div>

        <div class="controls keypad-container">
            <div class="darts-thrown-display" id="dartsThrownDisplay"></div>
            <div class="input-display" id="inputDisplay">0</div>
            <div class="checkout-suggestion" id="checkoutHint"></div>
            <div class="dartboard-keypad">
                <div class="modifiers">
                    <button class="key key-mod" id="modDouble">Double</button>
                    <button class="key key-mod" id="modTreble">Treble</button>
                </div>
                <div class="numbers" id="keypadNumbers">
                    <!-- Numbers 1-20 are dynamically generated by screen.game.js -->
                </div>
                <div class="specials" id="keypadSpecials">
                    <div class="specials-row">
                        <button class="key key-bull" data-score="25">OUTER BULL</button>
                        <button class="key key-bull" data-score="50">BULLSEYE</button>
                        <button class="key key-special" data-score="0">MISS</button>
                    </div>
                    <div class="specials-row">
                        <button class="key key-special key-del" id="undoBtn">UNDO</button>
                        <button class="key key-special key-submit" id="submitTurnBtn">SUBMIT</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="burnDownChartContainer" class="chart-container"></div>

        <!-- Win Modal (for leg wins) -->
        <div id="winModal" class="modal">
            <h2 id="winnerText">WINNER!</h2>
            <div class="confetti" id="winnerConfetti">Game Shot!</div>
            <div class="winner-stats" id="winnerStats"></div>
            <button class="btn btn-modal-action" id="nextLegBtn">Start Next Leg</button>
        </div>
    </div>

    <!-- Audio Elements -->
    <audio id="dartHitSound" src="sounds/click.mp3" preload="none"></audio>
    <audio id="bustSound" src="sounds/bust.mp3" preload="none"></audio>
    <audio id="oneEightySound" src="sounds/180.mp3" preload="none"></audio>
    <audio id="winSound" src="sounds/win.mp3" preload="none"></audio>

    <!--
        LOCAL DEVELOPMENT PRE-INIT SCRIPT
        This script runs BEFORE app.js to prevent real authentication attempts.
        It provides a fake JWT token so that app.js can initialize without errors.
    -->
    <script>
        window.DartsApp = {}; // Initialize the global namespace

        // --- Intercept the 'fetch' call for authentication ---
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const requestInfo = args[0];
            const requestInit = args[1] || {};

            // Check if this is the auth token request from app.js
            if (requestInfo === 'index.php' && requestInit.headers && requestInit.headers['X-Action'] === 'auth:getToken') {
                console.log('[LOCAL STUB] Intercepted auth:getToken request. Returning fake token.');
                // Return a fake successful response
                return Promise.resolve({
                    ok: true,
                    status: 200,
                    json: () => Promise.resolve({ success: true, token: 'local-dev-fake-token' })
                });
            }

            // For all other requests, use the original fetch function
            return originalFetch.apply(this, args);
        };
    </script>

    <!-- Include the real JS files -->
    <script src="js/app.js" defer></script>
    <script src="js/screen.game.js" defer></script>

    <!-- Local Initialization Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 1. Create Mock Data ---
            // This object simulates the data that would normally come from the backend.
            const mockMatchObject = {
                gameType: 501,
                matchLegs: 3,
                checkoutAssistant: true,
                soundEffects: true,
                // --- CORRECTED MOCK DATA FOR 4 PLAYERS ---
                players: [
                    {
                        name: 'Player 1',
                        score: 261,
                        dartsThrown: 6,
                        legsWon: 0,
                        scores: [401, 261] // After turn 1, after turn 2
                    },
                    {
                        name: 'Player 2',
                        score: 346,
                        dartsThrown: 6,
                        legsWon: 0,
                        scores: [441, 346] // After turn 1, after turn 2
                    },
                    {
                        name: 'Player 3',
                        score: 416,
                        dartsThrown: 3,
                        legsWon: 0,
                        scores: [416] // After turn 1
                    },
                    {
                        name: 'Player 4',
                        score: 460,
                        dartsThrown: 3,
                        legsWon: 0,
                        scores: [460] // After turn 1
                    }
                ],
                currentPlayerIndex: 2, // Player 3 is the active player
                currentLeg: 1,
                isOver: false,
                winnerName: null,
                // The history array tracks the score thrown each turn.
                // This now correctly matches the players' scores arrays.
                history: [
                    { playerIndex: 0, scoreThrown: 100, isBust: false }, // P1's 1st turn
                    { playerIndex: 1, scoreThrown: 60, isBust: false },  // P2's 1st turn
                    { playerIndex: 2, scoreThrown: 85, isBust: false },  // P3's 1st turn
                    { playerIndex: 3, scoreThrown: 41, isBust: false },  // P4's 1st turn
                    { playerIndex: 0, scoreThrown: 140, isBust: false }, // P1's 2nd turn
                    { playerIndex: 1, scoreThrown: 95, isBust: false },  // P2's 2nd turn
                ],
                standings: [],
            };

            // --- 2. Stub out DartsApp functions ---
            // We create dummy versions of functions that would normally make API calls

            // Prevent API calls from being made
            window.DartsApp.postAction = async function(action, data) {
                console.log(`[LOCAL STUB] postAction called for '${action}' with data:`, data);
                // To simulate a score submission, you could return a modified mock object here.
                return { success: true, match: mockMatchObject };
            };

            // Prevent screen changes
            window.DartsApp.showScreen = function(screenId) {
                console.log(`[LOCAL STUB] showScreen called for '${screenId}'.`);
            };

            // Override the JS function that renders the leaderboard
            window.DartsApp.updateLeaderboard = function(match) {
                const leaderboardElement = document.getElementById('leaderboard');
                leaderboardElement.innerHTML = match.players.map((p, index) => {
                    const pTotalPoints = (match.gameType - p.score);
                    const pLegAvg = p.dartsThrown > 0 ? (pTotalPoints / p.dartsThrown * 3).toFixed(2) : '0.00';
                    const maxTurns = Math.max(0, ...match.players.map(pl => pl.scores.length));

                    // Get this player's turns from the main history to find out what was thrown each turn.
                    const playerHistory = match.history.filter(turn => turn.playerIndex === index);
                    
                    let scoreHistoryHtml = '<p style="text-align: center; color: var(--text-color-secondary); font-size: 0.9em;">No turns yet.</p>';
                    if (maxTurns > 0) {
                        let tableRows = '';
                        for (let i = 0; i < maxTurns; i++) {
                            const remainingScore = p.scores[i];
                            const turnData = playerHistory[i];

                            if (turnData !== undefined) {
                                const scoreThrown = turnData.isBust ? 'BUST' : turnData.scoreThrown;
                                tableRows += `<tr><td>${i + 1}</td><td>${scoreThrown}</td><td>${remainingScore}</td></tr>`;
                            } else {
                                // Add a placeholder row for turns not yet taken by this player
                                tableRows += `<tr><td>${i + 1}</td><td>-</td><td>-</td></tr>`;
                            }
                        }
                        scoreHistoryHtml = `<table class="player-card__score-history">
                            <thead><tr><th>Turn</th><th>Thrown</th><th>Left</th></tr></thead>
                            <tbody>${tableRows}</tbody>
                           </table>`;
                    }

                    return `
                        <div class="player-column">
                            <div class="player-card player-card--header ${index === match.currentPlayerIndex ? 'active' : ''}">
                                <div>
                                    <div class="player-card__name">${p.name}</div>
                                    <div class="player-card__avg">Avg: ${pLegAvg}</div>
                                </div>
                                <div class="player-card__score">${p.score}</div>
                            </div>
                            <div class="player-card player-card--history">${scoreHistoryHtml}</div>
                        </div>
                    `;
                }).join('');
            };

            window.DartsApp.showMatchSummary = function(match) {
                console.log('[LOCAL STUB] showMatchSummary called with:', match);
                alert('Match Over! Winner: ' + match.winnerName);
            };

            // --- 3. Initialize the Game Screen ---
            // We wait a brief moment to ensure all other scripts have loaded.
            setTimeout(() => {
                if (window.DartsApp && typeof window.DartsApp.initGameScreen === 'function') {
                    const originalInitGameScreen = window.DartsApp.initGameScreen;

                    // Replace the entire init function with our local version
                    window.DartsApp.initGameScreen = function(match) {
                        console.log('[LOCAL OVERRIDE] Running local initGameScreen.');
                        // 1. Render our correct leaderboard first.
                        window.DartsApp.updateLeaderboard(match);
                        // 2. Call the original init function, but tell its UI renderer to do nothing.
                        originalInitGameScreen(match, { skipLeaderboardRender: true });
                    };

                    console.log('[LOCAL INIT] Initializing game screen with mock data.');
                    window.DartsApp.initGameScreen(mockMatchObject);
                } else {
                    console.error('[LOCAL INIT] DartsApp.initGameScreen is not available. Check script loading order.');
                    alert('Failed to initialize local game screen. See console for details.');
                }
            }, 100);
        });
    </script>

</body>
</html>